<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽卡模拟器</title>
    <style>
        body { font-family: "Microsoft YaHei", "Segoe UI", sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 20px; }
        .panel { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); flex: 1; min-width: 320px; }
        .panel h2 { margin-top: 0; border-bottom: 2px solid #e1e4e8; padding-bottom: 15px; font-size: 1.1em; color: #007bff; font-weight: 600; }
        .form-group { margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .form-group label { font-size: 0.9em; flex: 1; margin-right: 15px; color: #555; }
        .form-group input[type="number"] { width: 90px; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px; text-align: right; font-family: Consolas, monospace; transition: border 0.3s; }
        .form-group input[type="number"]:focus { border-color: #40a9ff; outline: none; }
        .form-group input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
        .section-divider { border: 0; border-top: 1px dashed #eee; margin: 15px 0; }
        
        .full-width { width: 100%; flex: 1 1 100%; }
        button { display: block; width: 100%; padding: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s, transform 0.1s; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,123,255,0.2); }
        button:hover { background-color: #0056b3; }
        button:active { transform: translateY(1px); }
        
        #output { background: #282c34; color: #abb2bf; padding: 25px; border-radius: 8px; font-family: "Consolas", "Monaco", monospace; white-space: pre-wrap; margin-top: 20px; min-height: 200px; line-height: 1.5; font-size: 0.95em; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <h1>卡池策略模拟器</h1>

    <div class="container">
        <!-- 用户策略与环境设置 -->
        <div class="panel">
            <h2>模拟环境与玩家策略</h2>
            
            <div class="form-group"><label>模拟总人数</label><input type="number" id="p_totalCount" value="10000"></div>
            <div class="form-group"><label>每人模拟的卡池数量</label><input type="number" id="p_pool" value="100"></div>
            <div class="form-group"><label>初始持有的自由抽数</label><input type="number" id="p_startDraw" value="50"></div>
            <div class="form-group"><label>每个卡池间隔可积攒的自由抽数</label><input type="number" id="p_everyPoorFreeDraw" value="15"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>目标池前垫多少层小保底</label><input type="number" id="p_dianzi" value="0"></div>
            <div class="form-group"><label>垫子池最多投入抽数</label><input type="number" id="p_dianziLimit" value="0"></div>
            <div class="form-group"><label>垫够层数但在X抽后补到60抽</label><input type="number" id="p_bu60Limt" value="50"></div>
            <div class="form-group"><label>若下个池仍是目标，是否继续垫？</label><input type="checkbox" id="p_isDian"></div>
            <div class="form-group"><label>连续目标池垫刀最大投入抽数</label><input type="number" id="p_targetDrawDianLimt" value="0"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>两目标池间最小非目标池间隔</label><input type="number" id="p_min" value="0"></div>
            <div class="form-group"><label>两目标池间最大非目标池间隔</label><input type="number" id="p_max" value="3"></div>
            <div class="form-group"><label>非人权池最大抽取上限 (0为不限制)</label><input type="number" id="p_useLimit" value="0"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>每多少个池出现一个人权池</label><input type="number" id="p_hyper" value="6"></div>
            <div class="form-group"><label>人权卡需要抽取的潜能数量</label><input type="number" id="p_hyperCount" value="5"></div>
            <div class="form-group"><label>人权池抽够潜能差X抽到240赠送潜能则补齐</label><input type="number" id="p_hyperBu240" value="30"></div>
            <div class="form-group"><label>非人权限定卡的价值修正 (0为默认)</label><input type="number" id="p_priceChange" value="0"></div>
        </div>

        <!-- 游戏基础规则设置 -->
        <div class="panel">
            <h2>游戏基础规则参数</h2>
            <div class="form-group"><label>6星基础概率</label><input type="number" id="c_per6" value="0.008" step="0.001"></div>
            <div class="form-group"><label>5星基础概率</label><input type="number" id="c_per5" value="0.08" step="0.01"></div>
            <div class="form-group"><label>6星概率提升幅度 (每抽)</label><input type="number" id="c_perAdd" value="0.05" step="0.01"></div>
            <div class="form-group"><label>6星开始累加概率的抽数</label><input type="number" id="c_drawAdd" value="65"></div>
            <div class="form-group"><label>6星硬保底抽数</label><input type="number" id="c_drawLimit" value="80"></div>
            <div class="form-group"><label>UP角色大保底 (硬保底)</label><input type="number" id="c_DrawUpLimit" value="120"></div>
            <div class="form-group"><label>卡池UP概率</label><input type="number" id="c_upPer" value="0.5" step="0.1"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>常驻池6星角色数量</label><input type="number" id="c_normalRole" value="5"></div>
            <div class="form-group"><label>限定池中歪出的限定数量</label><input type="number" id="c_limitWaiRole" value="2"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>多少抽赠送一个UP潜能 (大保底)</label><input type="number" id="c_freeLimit" value="240"></div>
            <div class="form-group"><label>不含保底免费10连阈值</label><input type="number" id="c_free30Draw" value="30"></div>
            <div class="form-group"><label>达到阈值赠送抽数</label><input type="number" id="c_free30DrawNum" value="10"></div>
            <div class="form-group"><label>赠送下个池10连阈值</label><input type="number" id="c_free60Draw" value="60"></div>
            <div class="form-group"><label>下个池赠送抽数</label><input type="number" id="c_free60DrawNum" value="10"></div>
            <div class="form-group"><label>开池免费赠送抽数</label><input type="number" id="c_poolFreeDraw" value="10"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>多少黄票兑换一抽</label><input type="number" id="c_rolebuyDraw" value="25"></div>
            <div class="form-group"><label>重复6星获得黄票</label><input type="number" id="c_normal6Draw" value="50"></div>
            <div class="form-group"><label>重复5星获得黄票</label><input type="number" id="c_normal5Draw" value="10"></div>
            
            <hr class="section-divider">
            
            <div class="form-group"><label>人权卡设定价值</label><input type="number" id="c_hyperPBase" value="1000"></div>
            <div class="form-group"><label>目标限定设定价值</label><input type="number" id="c_targetPBase" value="500"></div>
            <div class="form-group"><label>非目标限定设定价值</label><input type="number" id="c_waiPBase" value="250"></div>
            <div class="form-group"><label>普池角色设定价值</label><input type="number" id="c_nPBase" value="100"></div>
        </div>
    </div>

    <div class="container">
        <div class="full-width">
            <button onclick="runSimulation()">开始模拟计算</button>
            <div id="output">点击上方按钮开始模拟...</div>
        </div>
    </div>

    <script>
        // --- 全局配置变量 (将由输入框填充) ---
        let CFG = {};

        // --- 枚举定义 ---
        const DrawType = {
            normal4: 0,
            normal5: 1,
            normal6: 2,
            limitWai: 3,
            limit: 4
        };

        const PoolType = {
            None: 0,
            target: 1,
            hyper: 2
        };

        // --- 核心逻辑函数 ---

        function draw(nowLimit6Num, nowDraw6Num, nowDraw5Num) {
            if (nowLimit6Num === CFG.DrawUpLimit - 1) {
                return DrawType.limit;
            }
            let drawPer = CFG.per6;
            let perNow = Math.random();

            if (nowDraw6Num === CFG.drawLimit - 1) {
                return Draw6();
            } else if (nowDraw6Num < CFG.drawAdd) {
                if (perNow < drawPer) {
                    return Draw6();
                } else if (nowDraw5Num >= 9 || perNow < CFG.per5) {
                    return DrawType.normal5;
                } else {
                    return DrawType.normal4;
                }
            }

            // 概率累加阶段
            drawPer += (nowDraw6Num + 1 - CFG.drawAdd) * CFG.perAdd;

            if (perNow < drawPer) {
                return Draw6();
            } else if (nowDraw5Num >= 9 || perNow < CFG.per5) {
                return DrawType.normal5;
            } else {
                return DrawType.normal4;
            }
        }

        function Draw6() {
            if (Math.random() < CFG.upPer) {
                return DrawType.limit;
            }
            let rng = Math.floor(Math.random() * (CFG.normalRole + CFG.limitWaiRole));
            if (rng < CFG.limitWaiRole) {
                return DrawType.limitWai;
            }
            return DrawType.normal6;
        }

        function AddLimitMap(map, index) {
            if (index < 0) return;
            map[index] = true;
        }

        // --- 主模拟函数 ---
        function realDraw(totalCount, pool, dianzi, dianziLimit, bu60Limt, min, max, startDraw, everyPoorFreeDraw, isDian, targetDrawDianLimt, hyper, hyperCount, hyperBu240, useLimit, priceChange) {
            
            // 值设定
            let hyperP = CFG.hyperPBase;
            let targetP = CFG.targetPBase;
            let waiP = CFG.waiPBase;
            let nP = CFG.nPBase;

            if (priceChange > 0) {
                targetP = priceChange;
                waiP = priceChange;
            }

            // 统计变量
            let keDraw = 0;
            let hyperkeDraw = 0;
            let weapon = 0;
            let limitGettotal = 0;
            let totalTargetNumber = 0;
            let totalN6Number = 0;
            let totalPrice = 0;
            let maxKeDraw = 0;
            let hit120Count = 0;
            let totalDrawCount = 0; 
            let totalWaiCount = 0;

            let totalTarget = 0;
            let totalHyper = 0;
            let totalLimit = 0;
            let useTargetDraw = 0;
            let useHyperDraw = 0;
            let totalHyperLimit = 0;

            // 循环每一个用户
            for (let i = 0; i < totalCount; i++) {
                // 生成池子列表
                let targetPoorList = [];
                let n = 0;
                while (targetPoorList.length < pool + 1) {
                    let interval = Math.floor(Math.random() * (max - min + 1)) + min;
                    for (let j = 0; j < interval && targetPoorList.length < pool + 1; j++) {
                        n++;
                        if (n % hyper === 0) {
                            totalHyperLimit++;
                            targetPoorList.push(PoolType.hyper);
                        } else {
                            targetPoorList.push(PoolType.None);
                        }
                    }
                    n++;
                    if (n % hyper === 0) {
                        totalHyperLimit++;
                        targetPoorList.push(PoolType.hyper);
                    } else {
                        totalTargetNumber++;
                        targetPoorList.push(PoolType.target);
                    }
                }

                // 修正最后一个池子的计数
                switch (targetPoorList[targetPoorList.length - 1]) {
                    case PoolType.None: break;
                    case PoolType.target: totalTargetNumber--; break;
                    case PoolType.hyper: totalHyperLimit--; break;
                }

                let limitMap = {};

                let haveDraw = startDraw;
                let next60Free = false;
                let nowDraw6Num = 0;
                let nowDraw5Num = 0;
                let rolekeDraw = 0;
                let rolehyperkeDraw = 0;

                // 循环每个池子
                for (let j = 0; j < pool; j++) {
                    let poolType = targetPoorList[j];
                    let nextPoor = targetPoorList[j + 1];

                    let isGetTarget = false;
                    let nowLimit6Num = 0;
                    let addDraw = CFG.poolFreeDraw;
                    let nowPoorDraw = 0;
                    let getCount = 0;

                    if (next60Free) {
                        addDraw += CFG.free60DrawNum;
                    }

                    let needCount = 1;
                    if (poolType === PoolType.hyper) {
                        needCount += hyperCount;
                    }

                    // 1. 处理免费送的抽
                    for (let h = 0; h < addDraw; h++) {
                        nowPoorDraw++;
                        totalDrawCount++;
                        let drawFree = draw(isGetTarget ? 0 : nowLimit6Num, nowDraw6Num, nowDraw5Num);

                        switch (drawFree) {
                            case DrawType.normal4:
                                weapon += CFG.weapon4;
                                nowLimit6Num++; nowDraw6Num++; nowDraw5Num++;
                                break;
                            case DrawType.normal5:
                                weapon += CFG.weapon5;
                                haveDraw += CFG.normal5Draw / CFG.rolebuyDraw;
                                nowLimit6Num++; nowDraw6Num++; nowDraw5Num = 0;
                                break;
                            case DrawType.limitWai:
                                totalLimit++; totalN6Number++; weapon += CFG.weapon6;
                                let indexWai = Math.random() < 0.5 ? j - 2 : j - 1;
                                if (limitMap[indexWai]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                AddLimitMap(limitMap, indexWai);

                                if (indexWai >= 0) {
                                    switch (targetPoorList[indexWai]) {
                                        case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                        case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                        default: totalWaiCount++; totalPrice += waiP; break;
                                    }
                                }
                                nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0;
                                break;
                            case DrawType.normal6:
                                totalWaiCount++; totalPrice += nP; totalN6Number++; weapon += CFG.weapon6;
                                haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0;
                                break;
                            case DrawType.limit:
                                totalLimit++;
                                switch (poolType) {
                                    case PoolType.target: getCount++; totalTarget++; totalPrice += targetP; break;
                                    case PoolType.hyper: getCount++; totalHyper++; totalPrice += hyperP; break;
                                    default: totalWaiCount++; totalPrice += waiP; break;
                                }
                                totalN6Number++; isGetTarget = true; weapon += CFG.weapon6;
                                if (limitMap[j]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                AddLimitMap(limitMap, j);
                                nowDraw6Num = 0; nowDraw5Num = 0;
                                break;
                        }
                    }

                    // 2. 正式抽卡阶段
                    let use30Free = false;
                    if (poolType !== PoolType.None) {
                        while ((!isGetTarget || getCount < needCount) || 
                               (nowPoorDraw >= bu60Limt && nowPoorDraw < CFG.free60Draw) || 
                               (poolType === PoolType.hyper && nowPoorDraw % CFG.freeLimit > CFG.freeLimit - hyperBu240)) {
                            
                            if (useLimit > 0 && nowPoorDraw >= useLimit && poolType !== PoolType.hyper) break;

                            nowPoorDraw++;
                            if (haveDraw <= 0) {
                                haveDraw++;
                                if (poolType === PoolType.target) { keDraw++; rolekeDraw++; }
                                else { hyperkeDraw++; rolehyperkeDraw++; }
                            }
                            if (poolType === PoolType.target) useTargetDraw++;
                            else useHyperDraw++;

                            haveDraw--;
                            
                            if (nowPoorDraw % CFG.freeLimit === 0) getCount++;
                            if (nowLimit6Num === CFG.DrawUpLimit - 1) hit120Count++;

                            totalDrawCount++;
                            let targetDraw = draw(isGetTarget ? 0 : nowLimit6Num, nowDraw6Num, nowDraw5Num);

                            switch (targetDraw) {
                                case DrawType.normal4:
                                    weapon += CFG.weapon4;
                                    nowLimit6Num++; nowDraw6Num++; nowDraw5Num++;
                                    break;
                                case DrawType.normal5:
                                    weapon += CFG.weapon5;
                                    haveDraw += CFG.normal5Draw / CFG.rolebuyDraw;
                                    nowLimit6Num++; nowDraw6Num++; nowDraw5Num = 0;
                                    break;
                                case DrawType.limitWai:
                                    totalLimit++; totalN6Number++; weapon += CFG.weapon6;
                                    let index = Math.random() < 0.5 ? j - 2 : j - 1;
                                    if (limitMap[index]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                    AddLimitMap(limitMap, index);
                                    if (index >= 0) {
                                        switch (targetPoorList[index]) {
                                            case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                            case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                            default: totalWaiCount++; totalPrice += waiP; break;
                                        }
                                    }
                                    nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0;
                                    break;
                                case DrawType.normal6:
                                    totalWaiCount++; totalPrice += nP; totalN6Number++; weapon += CFG.weapon6;
                                    haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                    nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0;
                                    break;
                                case DrawType.limit:
                                    totalLimit++; getCount++;
                                    switch (poolType) {
                                        case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                        case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                        default: totalWaiCount++; totalPrice += waiP; break;
                                    }
                                    totalN6Number++; isGetTarget = true; weapon += CFG.weapon6;
                                    if (limitMap[j]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                    AddLimitMap(limitMap, j);
                                    nowDraw6Num = 0; nowDraw5Num = 0;
                                    break;
                            }

                            // 30抽送的免费10连
                            if (!use30Free && nowPoorDraw >= CFG.free30Draw) {
                                use30Free = true;
                                let freeDraw5Num = 0;
                                for (let h = 0; h < CFG.free30DrawNum; h++) {
                                    let drawFree = draw(0, 0, freeDraw5Num);

                                    switch (drawFree) {
                                        case DrawType.normal4:
                                            weapon += CFG.weapon4; freeDraw5Num++; break;
                                        case DrawType.normal5:
                                            weapon += CFG.weapon5; haveDraw += CFG.normal5Draw / CFG.rolebuyDraw; freeDraw5Num = 0; break;
                                        case DrawType.limitWai:
                                            totalLimit++; totalN6Number++; weapon += CFG.weapon6;
                                            let index = Math.random() < 0.5 ? j - 2 : j - 1;
                                            if (limitMap[index]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                            AddLimitMap(limitMap, index);
                                            if (index >= 0) {
                                                switch (targetPoorList[index]) {
                                                    case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                                    case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                                    default: totalWaiCount++; totalPrice += waiP; break;
                                                }
                                            }
                                            freeDraw5Num = 0; break;
                                        case DrawType.normal6:
                                            totalN6Number++; totalWaiCount++; weapon += CFG.weapon6;
                                            haveDraw += CFG.normal6Draw / CFG.rolebuyDraw; totalPrice += nP; freeDraw5Num = 0; break;
                                        case DrawType.limit:
                                            totalLimit++;
                                            switch (poolType) {
                                                case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                                case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                                default: totalWaiCount++; totalPrice += waiP; break;
                                            }
                                            totalN6Number++; isGetTarget = true; weapon += CFG.weapon6;
                                            if (limitMap[j]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                            AddLimitMap(limitMap, j);
                                            freeDraw5Num = 0; break;
                                    }
                                }
                            }
                        }
                    }

                    // 3. 垫刀逻辑
                    if (poolType === PoolType.None || isDian) {
                        let TargetDianDraw = 0;
                        if (nextPoor !== PoolType.None && nowDraw6Num < dianzi) {
                            while (nowDraw6Num < dianzi || (nowPoorDraw >= bu60Limt && nowPoorDraw < CFG.free60Draw)) {
                                if (useLimit > 0 && nowPoorDraw >= useLimit) break;
                                nowPoorDraw++;

                                if (nextPoor === PoolType.target) useTargetDraw++;
                                else useHyperDraw++;

                                TargetDianDraw++;
                                if (haveDraw <= 0) {
                                    haveDraw++;
                                    if (nextPoor === PoolType.target) { keDraw++; rolekeDraw++; }
                                    else { hyperkeDraw++; rolehyperkeDraw++; }
                                }

                                haveDraw--;
                                totalDrawCount++;
                                let drawDianZi = draw(isGetTarget ? 0 : nowLimit6Num, nowDraw6Num, nowDraw5Num);

                                switch (drawDianZi) {
                                    case DrawType.normal4:
                                        weapon += CFG.weapon4; nowLimit6Num++; nowDraw6Num++; nowDraw5Num++; break;
                                    case DrawType.normal5:
                                        weapon += CFG.weapon5; haveDraw += CFG.normal5Draw / CFG.rolebuyDraw;
                                        nowLimit6Num++; nowDraw6Num++; nowDraw5Num = 0; break;
                                    case DrawType.limitWai:
                                        totalLimit++; totalN6Number++; weapon += CFG.weapon6;
                                        let index = Math.random() < 0.5 ? j - 2 : j - 1;
                                        if (limitMap[index]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                        AddLimitMap(limitMap, index);
                                        if (index >= 0) {
                                            switch (targetPoorList[index]) {
                                                case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                                case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                                default: totalWaiCount++; totalPrice += waiP; break;
                                            }
                                        }
                                        nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0; break;
                                    case DrawType.normal6:
                                        totalWaiCount++; totalN6Number++; weapon += CFG.weapon6;
                                        haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                        nowLimit6Num++; nowDraw6Num = 0; nowDraw5Num = 0; break;
                                    case DrawType.limit:
                                        totalLimit++;
                                        switch (poolType) {
                                            case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                            case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                            default: totalWaiCount++; totalPrice += waiP; break;
                                        }
                                        totalN6Number++; isGetTarget = true; weapon += CFG.weapon6;
                                        if (limitMap[j]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                        AddLimitMap(limitMap, j);
                                        nowDraw6Num = 0; nowDraw5Num = 0; break;
                                }

                                // 垫刀阶段触发30抽赠送
                                if (!use30Free && nowPoorDraw >= CFG.free30Draw) {
                                    use30Free = true;
                                    let freeDraw5Num = 0;
                                    for (let h = 0; h < CFG.free30DrawNum; h++) {
                                        let drawFree = draw(0, 0, freeDraw5Num);
                                        switch (drawFree) {
                                            case DrawType.normal4:
                                                weapon += CFG.weapon4; freeDraw5Num++; break;
                                            case DrawType.normal5:
                                                weapon += CFG.weapon5; haveDraw += CFG.normal5Draw / CFG.rolebuyDraw; freeDraw5Num = 0; break;
                                            case DrawType.limitWai:
                                                totalLimit++; totalN6Number++; weapon += CFG.weapon6;
                                                let index = Math.random() < 0.5 ? j - 2 : j - 1;
                                                if (limitMap[index]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                                AddLimitMap(limitMap, index);
                                                if (index >= 0) {
                                                    switch (targetPoorList[index]) {
                                                        case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                                        case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                                        default: totalPrice += waiP; totalWaiCount++; break;
                                                    }
                                                }
                                                freeDraw5Num = 0; break;
                                            case DrawType.normal6:
                                                totalN6Number++; totalWaiCount++; weapon += CFG.weapon6;
                                                haveDraw += CFG.normal6Draw / CFG.rolebuyDraw; freeDraw5Num = 0; break;
                                            case DrawType.limit:
                                                totalLimit++;
                                                switch (poolType) {
                                                    case PoolType.target: totalTarget++; totalPrice += targetP; break;
                                                    case PoolType.hyper: totalHyper++; totalPrice += hyperP; break;
                                                    default: totalPrice += waiP; totalWaiCount++; break;
                                                }
                                                totalN6Number++; isGetTarget = true; weapon += CFG.weapon6;
                                                if (limitMap[j]) haveDraw += CFG.normal6Draw / CFG.rolebuyDraw;
                                                AddLimitMap(limitMap, j);
                                                freeDraw5Num = 0; break;
                                        }
                                    }
                                }

                                if (nowPoorDraw >= bu60Limt && nowPoorDraw < CFG.free60Draw) {
                                    continue;
                                }
                                if (poolType === PoolType.None) {
                                    if (nowPoorDraw >= dianziLimit) break;
                                } else {
                                    if (TargetDianDraw >= targetDrawDianLimt) break;
                                }
                            }
                        }
                    }

                    if (nowPoorDraw >= CFG.free60Draw) {
                        next60Free = true;
                    } else {
                        next60Free = false;
                    }
                    haveDraw += everyPoorFreeDraw;
                } // End of Pool Loop

                if (rolekeDraw + rolehyperkeDraw > maxKeDraw) maxKeDraw = rolekeDraw + rolehyperkeDraw;
                limitGettotal += Object.keys(limitMap).length;

            } // End of User Loop

            // --- 输出结果 ---
            let out = [];
            out.push("模拟 " + totalCount + " 人，每人抽 " + pool + " 池");
            out.push("\n========= 基础统计 =========");
            out.push("平均每人经历人权池：" + (totalHyperLimit / totalCount).toFixed(2));
            out.push("平均每人经历目标池：" + (totalTargetNumber / totalCount).toFixed(2));

            out.push("\n========= 产出统计 =========");
            out.push("平均获得人权卡(本体+潜能)：" + (totalHyper / totalCount).toFixed(2));
            out.push("平均获得目标UP(人权外)：" + (totalTarget / totalCount).toFixed(2));
            out.push("平均每人获得限定数量：" + (totalLimit / totalCount).toFixed(2));
            out.push("平均获得6星总数：" + (totalN6Number / totalCount).toFixed(2));
            out.push("图鉴收集率：" + (limitGettotal / totalCount / pool * 100).toFixed(2) + "%");

            out.push("\n========= 成本与价值 =========");
            out.push("平均每人每人权池投入的自由抽数(含垫子)：" + (useHyperDraw / totalHyperLimit).toFixed(2));
            out.push("平均每人每目标池投入的自由抽数(含垫子)：" + (useTargetDraw / totalTargetNumber).toFixed(2));
            out.push("平均每人每人权池需要额外购买的抽数(含垫子)：" + (hyperkeDraw / totalHyperLimit).toFixed(2));
            out.push("平均每人每目标池需要额外购买的抽数(人权外)：" + (keDraw / totalTargetNumber).toFixed(2));

            out.push("平均每人每池获得武器券总量：" + (weapon / totalCount / pool).toFixed(2));

            out.push("\n========= 风险评估 =========");
            out.push("平均额外购买抽数：" + ((hyperkeDraw + keDraw) / totalCount).toFixed(2));
            out.push("最黑非酋额外购买抽数：" + maxKeDraw);
            out.push("120抽硬保底触发概率：" + (hit120Count / (totalHyperLimit + totalTargetNumber) * 100).toFixed(4) + "%");

            out.push("\n========= 每一抽的含金量 =========");
            out.push("人权角色每个价值：" + hyperP);
            out.push("目标池限定每个价值：" + targetP);
            out.push("非目标池限定每个价值：" + waiP);
            out.push("普池角色每个价值：" + nP);
            out.push("每自由抽的角色价值：" + (totalPrice / (useTargetDraw + useHyperDraw)).toFixed(2));
            out.push("每自由抽产出武器券：" + (weapon / (useTargetDraw + useHyperDraw)).toFixed(2));

            document.getElementById("output").textContent = out.join("\n");
        }

        // --- 读取配置并启动 ---
        function runSimulation() {
            document.getElementById("output").textContent = "模拟计算中...";

            // 使用 setTimeout 让 UI 有机会刷新显示 "计算中"
            setTimeout(() => {
                // 1. 读取全局配置
                CFG = {
                    per6: parseFloat(document.getElementById("c_per6").value),
                    per5: parseFloat(document.getElementById("c_per5").value),
                    perAdd: parseFloat(document.getElementById("c_perAdd").value),
                    drawAdd: parseInt(document.getElementById("c_drawAdd").value),
                    drawLimit: parseInt(document.getElementById("c_drawLimit").value),
                    DrawUpLimit: parseFloat(document.getElementById("c_DrawUpLimit").value),
                    upPer: parseFloat(document.getElementById("c_upPer").value),
                    normalRole: parseInt(document.getElementById("c_normalRole").value),
                    limitWaiRole: parseInt(document.getElementById("c_limitWaiRole").value),
                    freeLimit: parseFloat(document.getElementById("c_freeLimit").value),
                    free30Draw: parseFloat(document.getElementById("c_free30Draw").value),
                    free30DrawNum: parseInt(document.getElementById("c_free30DrawNum").value),
                    free60Draw: parseFloat(document.getElementById("c_free60Draw").value),
                    free60DrawNum: parseInt(document.getElementById("c_free60DrawNum").value),
                    poolFreeDraw: parseInt(document.getElementById("c_poolFreeDraw").value),
                    rolebuyDraw: parseFloat(document.getElementById("c_rolebuyDraw").value),
                    normal6Draw: parseFloat(document.getElementById("c_normal6Draw").value),
                    normal5Draw: parseFloat(document.getElementById("c_normal5Draw").value),
                    weapon4: 20,
                    weapon5: 200,
                    weapon6: 2000,
                    hyperPBase: parseFloat(document.getElementById("c_hyperPBase").value),
                    targetPBase: parseFloat(document.getElementById("c_targetPBase").value),
                    waiPBase: parseFloat(document.getElementById("c_waiPBase").value),
                    nPBase: parseFloat(document.getElementById("c_nPBase").value)
                };

                // 2. 读取参数 (对应 realDraw 的参数顺序)
                let totalCount = parseInt(document.getElementById("p_totalCount").value);
                let pool = parseInt(document.getElementById("p_pool").value);
                let dianzi = parseInt(document.getElementById("p_dianzi").value);
                let dianziLimit = parseInt(document.getElementById("p_dianziLimit").value);
                let bu60Limt = parseInt(document.getElementById("p_bu60Limt").value);
                let min = parseInt(document.getElementById("p_min").value);
                let max = parseInt(document.getElementById("p_max").value);
                let startDraw = parseInt(document.getElementById("p_startDraw").value);
                let everyPoorFreeDraw = parseInt(document.getElementById("p_everyPoorFreeDraw").value);
                let isDian = document.getElementById("p_isDian").checked;
                let targetDrawDianLimt = parseInt(document.getElementById("p_targetDrawDianLimt").value);
                let hyper = parseInt(document.getElementById("p_hyper").value);
                let hyperCount = parseInt(document.getElementById("p_hyperCount").value);
                let hyperBu240 = parseInt(document.getElementById("p_hyperBu240").value);
                let useLimit = parseInt(document.getElementById("p_useLimit").value);
                let priceChange = parseInt(document.getElementById("p_priceChange").value);

                // 3. 执行
                realDraw(totalCount, pool, dianzi, dianziLimit, bu60Limt, min, max, startDraw, everyPoorFreeDraw, isDian, targetDrawDianLimt, hyper, hyperCount, hyperBu240, useLimit, priceChange);
            }, 50);
        }

    </script>
</body>
</html>